<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socket Server Test Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.19.0.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
      }

      .panel h2 {
        color: #4a5568;
        margin-bottom: 20px;
        font-size: 24px;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 10px;
      }

      .auth-section {
        background: #f7fafc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 2px solid #e2e8f0;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #2d3748;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: transform 0.2s, box-shadow 0.2s;
        margin: 5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .btn:disabled {
        background: #a0aec0;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-success {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      }

      .btn-danger {
        background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
      }

      .btn-warning {
        background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-connected {
        background-color: #48bb78;
      }

      .status-disconnected {
        background-color: #f56565;
      }

      .status-busy {
        background-color: #ed8936;
      }

      .messages-container {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        height: 300px;
        overflow-y: auto;
        padding: 15px;
        margin: 15px 0;
      }

      .message {
        background: white;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .message-sent {
        background: #e6fffa;
        border-left-color: #38b2ac;
      }

      .message-received {
        background: #ebf8ff;
        border-left-color: #4299e1;
      }

      .message-system {
        background: #fffaf0;
        border-left-color: #ed8936;
        font-style: italic;
      }

      .video-container {
        background: #1a202c;
        border-radius: 8px;
        margin: 15px 0;
        overflow: hidden;
        position: relative;
      }

      .video-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        padding: 10px;
      }

      .video-element {
        width: 100%;
        height: 200px;
        background: #2d3748;
        border-radius: 6px;
        object-fit: cover;
      }

      .video-controls {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
      }

      .logs-container {
        background: #1a202c;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 8px;
        height: 200px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
        line-height: 1.4;
      }

      .log-entry {
        margin-bottom: 5px;
        padding: 2px 0;
      }

      .log-error {
        color: #fed7d7;
      }
      .log-success {
        color: #c6f6d5;
      }
      .log-info {
        color: #bee3f8;
      }

      .session-info {
        background: #edf2f7;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 768px) {
        .main-grid {
          grid-template-columns: 1fr;
        }

        .container {
          padding: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ðŸ”® Astrologer Socket Server Test Interface</h1>
        <p>
          Test all socket functionalities including chat, voice, and video
          sessions
        </p>
      </div>

      <div class="main-grid">
        <!-- User Panel -->
        <div class="panel">
          <h2>ðŸ‘¤ User Panel</h2>

          <div class="auth-section">
            <div class="form-group">
              <label>JWT Token:</label>
              <textarea
                id="userToken"
                placeholder="Enter user JWT token here"
                rows="3"
              ></textarea>
            </div>
            <button id="connectUser" class="btn">Connect as User</button>
            <span id="userStatus">
              <span class="status-indicator status-disconnected"></span>
              Disconnected
            </span>
          </div>

          <div id="userActions" class="hidden">
            <h3>Request Session</h3>
            <div class="form-group">
              <label>Expert ID:</label>
              <input type="text" id="expertId" placeholder="Enter expert ID" />
            </div>
            <div class="form-group">
              <label>Session Mode:</label>
              <select id="sessionMode">
                <option value="chat">Chat</option>
                <option value="call">Voice Call</option>
                <option value="video">Video Call</option>
              </select>
            </div>
            <div class="form-group">
              <label>Full Name:</label>
              <input type="text" id="fullName" placeholder="Full Name" />
            </div>
            <div class="form-group">
              <label>Date of Birth:</label>
              <input type="date" id="dateOfBirth" />
            </div>
            <div class="form-group">
              <label>Gender:</label>
              <select id="gender">
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Time of Birth:</label>
              <input type="time" id="timeOfBirth" />
            </div>
            <div class="form-group">
              <label>Place of Birth:</label>
              <input
                type="text"
                id="placeOfBirth"
                placeholder="Place of Birth"
              />
            </div>
            <div class="form-group">
              <label>Phone Number:</label>
              <input type="tel" id="phoneNumber" placeholder="Phone Number" />
            </div>
            <button id="requestSession" class="btn">Request Session</button>
          </div>

          <div id="userSessionActions" class="hidden">
            <div class="session-info">
              <h4>Active Session</h4>
              <p>
                <strong>Session ID:</strong> <span id="userSessionId"></span>
              </p>
              <p><strong>Mode:</strong> <span id="userSessionMode"></span></p>
              <p><strong>Room ID:</strong> <span id="userRoomId"></span></p>
            </div>

            <div id="userChatSection" class="hidden">
              <div class="messages-container" id="userMessages"></div>
              <div class="form-group">
                <input
                  type="text"
                  id="userMessageInput"
                  placeholder="Type your message..."
                />
                <button id="sendUserMessage" class="btn">Send</button>
              </div>
            </div>

            <div id="userCallSection" class="hidden">
              <div class="video-container">
                <div class="video-grid">
                  <div id="userLocalVideo" class="video-element"></div>
                  <div id="userRemoteVideo" class="video-element"></div>
                </div>
                <div class="video-controls">
                  <button id="userMuteBtn" class="btn btn-warning">Mute</button>
                  <button id="userVideoBtn" class="btn btn-warning">
                    Video Off
                  </button>
                  <button id="userEndCallBtn" class="btn btn-danger">
                    End Call
                  </button>
                </div>
              </div>
            </div>

            <button id="endUserSession" class="btn btn-danger">
              End Session
            </button>
          </div>
        </div>

        <!-- Expert Panel -->
        <div class="panel">
          <h2>ðŸ”® Expert Panel</h2>

          <div class="auth-section">
            <div class="form-group">
              <label>JWT Token:</label>
              <textarea
                id="expertToken"
                placeholder="Enter expert JWT token here"
                rows="3"
              ></textarea>
            </div>
            <button id="connectExpert" class="btn">Connect as Expert</button>
            <span id="expertStatus">
              <span class="status-indicator status-disconnected"></span>
              Disconnected
            </span>
          </div>

          <div id="expertActions" class="hidden">
            <div id="sessionRequests">
              <h3>Session Requests</h3>
              <div id="requestsList"></div>
            </div>
          </div>

          <div id="expertSessionActions" class="hidden">
            <div class="session-info">
              <h4>Active Session</h4>
              <p>
                <strong>Session ID:</strong> <span id="expertSessionId"></span>
              </p>
              <p><strong>Mode:</strong> <span id="expertSessionMode"></span></p>
              <p><strong>Room ID:</strong> <span id="expertRoomId"></span></p>
            </div>

            <div id="expertChatSection" class="hidden">
              <div class="messages-container" id="expertMessages"></div>
              <div class="form-group">
                <input
                  type="text"
                  id="expertMessageInput"
                  placeholder="Type your message..."
                />
                <button id="sendExpertMessage" class="btn">Send</button>
              </div>
            </div>

            <div id="expertCallSection" class="hidden">
              <div class="video-container">
                <div class="video-grid">
                  <div id="expertLocalVideo" class="video-element"></div>
                  <div id="expertRemoteVideo" class="video-element"></div>
                </div>
                <div class="video-controls">
                  <button id="expertMuteBtn" class="btn btn-warning">
                    Mute
                  </button>
                  <button id="expertVideoBtn" class="btn btn-warning">
                    Video Off
                  </button>
                  <button id="expertEndCallBtn" class="btn btn-danger">
                    End Call
                  </button>
                </div>
              </div>
            </div>

            <button id="endExpertSession" class="btn btn-danger">
              End Session
            </button>
          </div>
        </div>
      </div>

      <!-- Logs Panel -->
      <div class="panel">
        <h2>ðŸ“‹ System Logs</h2>
        <div class="logs-container" id="logs"></div>
        <button id="clearLogs" class="btn btn-warning">Clear Logs</button>
      </div>
    </div>

    <script>
      // Global variables
      let userSocket = null;
      let expertSocket = null;
      let userAgoraClient = null;
      let expertAgoraClient = null;
      let currentUserSession = null;
      let currentExpertSession = null;

      // Utility functions
      function log(message, type = "info") {
        const logsContainer = document.getElementById("logs");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.className = `log-entry log-${type}`;
        logEntry.textContent = `[${timestamp}] ${message}`;
        logsContainer.appendChild(logEntry);
        logsContainer.scrollTop = logsContainer.scrollHeight;
      }

      function addMessage(containerId, message, type = "received") {
        const container = document.getElementById(containerId);
        const messageEl = document.createElement("div");
        messageEl.className = `message message-${type}`;

        if (typeof message === "object") {
          messageEl.innerHTML = `
                    <div><strong>${message.senderId}:</strong> ${
            message.message
          }</div>
                    <small>${new Date(
                      message.timestamp
                    ).toLocaleTimeString()}</small>
                `;
        } else {
          messageEl.textContent = message;
        }

        container.appendChild(messageEl);
        container.scrollTop = container.scrollHeight;
      }

      // User Socket Functions
      document.getElementById("connectUser").addEventListener("click", () => {
        const token = document.getElementById("userToken").value.trim();
        if (!token) {
          alert("Please enter JWT token");
          return;
        }

        userSocket = io("https://api.sanatanvision.com", {
          auth: { token: token },
        });

        userSocket.on("connect", () => {
          log("User connected successfully", "success");
          document.getElementById("userStatus").innerHTML =
            '<span class="status-indicator status-connected"></span>Connected';
          document.getElementById("userActions").classList.remove("hidden");
        });

        userSocket.on("connect_error", (error) => {
          log(`User connection error: ${error.message}`, "error");
        });

        userSocket.on("session_created", (data) => {
          log(`Session created: ${JSON.stringify(data)}`, "success");
          currentUserSession = data;
          document.getElementById("userSessionId").textContent = data.sessionId;
          document.getElementById("userSessionMode").textContent = data.mode;
          document.getElementById("userRoomId").textContent = data.roomId;

          // Join the session
          userSocket.emit("join_session", {
            sessionId: data.sessionId,
            roomId: data.roomId,
          });
        });

        userSocket.on("joined_session", (data) => {
          log(`Joined session: ${JSON.stringify(data)}`, "success");
          document
            .getElementById("userSessionActions")
            .classList.remove("hidden");

          if (data.mode === "chat") {
            document
              .getElementById("userChatSection")
              .classList.remove("hidden");
          } else if (data.mode === "call" || data.mode === "video") {
            document
              .getElementById("userCallSection")
              .classList.remove("hidden");
            if (currentUserSession.agoraToken) {
              initializeUserAgora();
            }
          }
        });

        userSocket.on("session_request_failed", (data) => {
          log(`Session request failed: ${data.error}`, "error");
          alert(`Session request failed: ${data.error}`);
        });

        userSocket.on("session_rejected", (data) => {
          log(`Session rejected: ${data.reason}`, "error");
          alert(`Session rejected: ${data.reason}`);
          resetUserSession();
        });

        userSocket.on("receive_message", (data) => {
          log(`Message received: ${JSON.stringify(data)}`, "info");
          addMessage("userMessages", data, "received");
        });

        userSocket.on("session_ended", (data) => {
          log(`Session ended: ${data.reason}`, "info");
          alert(`Session ended: ${data.reason}`);
          resetUserSession();
        });

        userSocket.on("billing_update", (data) => {
          log(`Billing update: ${JSON.stringify(data)}`, "info");
        });

        userSocket.on("call_started", (data) => {
          log(`Call started: ${JSON.stringify(data)}`, "success");
        });

        userSocket.on("disconnect", () => {
          log("User disconnected", "error");
          document.getElementById("userStatus").innerHTML =
            '<span class="status-indicator status-disconnected"></span>Disconnected';
          resetUserSession();
        });
      });

      // Expert Socket Functions
      document.getElementById("connectExpert").addEventListener("click", () => {
        const token = document.getElementById("expertToken").value.trim();
        if (!token) {
          alert("Please enter JWT token");
          return;
        }

        expertSocket = io("https://api.sanatanvision.com", {
          auth: { token: token },
        });

        expertSocket.on("connect", () => {
          log("Expert connected successfully", "success");
          document.getElementById("expertStatus").innerHTML =
            '<span class="status-indicator status-connected"></span>Connected';
          document.getElementById("expertActions").classList.remove("hidden");
        });

        expertSocket.on("connect_error", (error) => {
          log(`Expert connection error: ${error.message}`, "error");
        });

        expertSocket.on("session_request", (data) => {
          log(`Session request received: ${JSON.stringify(data)}`, "info");
          displaySessionRequest(data);
        });

        expertSocket.on("receive_message", (data) => {
          log(`Message received: ${JSON.stringify(data)}`, "info");
          addMessage("expertMessages", data, "received");
        });

        expertSocket.on("session_ended", (data) => {
          log(`Session ended: ${data.reason}`, "info");
          alert(`Session ended: ${data.reason}`);
          resetExpertSession();
        });

        expertSocket.on("participant_joined", (data) => {
          log(`Participant joined: ${JSON.stringify(data)}`, "info");
        });

        expertSocket.on("call_started", (data) => {
          log(`Call started: ${JSON.stringify(data)}`, "success");
        });

        expertSocket.on("disconnect", () => {
          log("Expert disconnected", "error");
          document.getElementById("expertStatus").innerHTML =
            '<span class="status-indicator status-disconnected"></span>Disconnected';
          resetExpertSession();
        });
      });

      // Session Request Functions
      document
        .getElementById("requestSession")
        .addEventListener("click", () => {
          if (!userSocket) {
            alert("Please connect as user first");
            return;
          }

          const sessionData = {
            expertId: document.getElementById("expertId").value,
            mode: document.getElementById("sessionMode").value,
            fullName: document.getElementById("fullName").value,
            dateOfBirth: document.getElementById("dateOfBirth").value,
            gender: document.getElementById("gender").value,
            timeOfBirth: document.getElementById("timeOfBirth").value,
            placeOfBirth: document.getElementById("placeOfBirth").value,
            phoneNumber: document.getElementById("phoneNumber").value,
          };

          userSocket.emit("request_session", sessionData);
          log(`Requesting session: ${JSON.stringify(sessionData)}`, "info");
        });

      function displaySessionRequest(data) {
        const requestsList = document.getElementById("requestsList");
        const requestEl = document.createElement("div");
        requestEl.className = "session-info";
        requestEl.innerHTML = `
    <h4>Session Request</h4>
    <p><strong>Session ID:</strong> ${data.sessionId}</p>
    <p><strong>Mode:</strong> ${data.mode}</p>
    <p><strong>User:</strong> ${data.consultationDetails.fullName}</p>
    <p><strong>DOB:</strong> ${data.consultationDetails.dateOfBirth}</p>
    <button class="btn btn-success accept-btn" 
        data-session-id="${data.sessionId}" 
        data-room-id="${data.roomId}" 
        data-mode="${data.mode}" 
        data-info='${JSON.stringify(data).replace(/'/g, "&apos;")}'
    >Accept</button>
    <button onclick="rejectSession('${
      data.sessionId
    }')" class="btn btn-danger">Reject</button>
`;
        requestsList.appendChild(requestEl);

        requestEl
          .querySelector(".accept-btn")
          .addEventListener("click", function () {
            const sessionId = this.dataset.sessionId;
            const roomId = this.dataset.roomId;
            const mode = this.dataset.mode;
            const sessionData = decodeURIComponent(this.dataset.info);

            acceptSession(sessionId, roomId, mode, sessionData);
          });
      }

      function acceptSession(sessionId, roomId, mode, sessionData) {
        if (!expertSocket) return;

        currentExpertSession = JSON.parse(sessionData);

        // Join the session
        expertSocket.emit("join_session", {
          sessionId: sessionId,
          roomId: roomId,
        });

        document.getElementById("expertSessionId").textContent = sessionId;
        document.getElementById("expertSessionMode").textContent = mode;
        document.getElementById("expertRoomId").textContent = roomId;
        document
          .getElementById("expertSessionActions")
          .classList.remove("hidden");

        if (mode === "chat") {
          document
            .getElementById("expertChatSection")
            .classList.remove("hidden");
        } else if (mode === "call" || mode === "video") {
          document
            .getElementById("expertCallSection")
            .classList.remove("hidden");
          if (currentExpertSession.agoraToken) {
            initializeExpertAgora();
          }
        }

        // Clear the request
        document.getElementById("requestsList").innerHTML = "";
        log(`Accepted session: ${sessionId}`, "success");
      }

      function rejectSession(sessionId) {
        if (!expertSocket) return;

        expertSocket.emit("reject_session", {
          sessionId: sessionId,
          reason: "Expert is not available",
        });

        // Clear the request
        document.getElementById("requestsList").innerHTML = "";
        log(`Rejected session: ${sessionId}`, "info");
      }

      // Message Functions
      document
        .getElementById("sendUserMessage")
        .addEventListener("click", () => {
          sendMessage("user");
        });

      document
        .getElementById("sendExpertMessage")
        .addEventListener("click", () => {
          sendMessage("expert");
        });

      document
        .getElementById("userMessageInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            sendMessage("user");
          }
        });

      document
        .getElementById("expertMessageInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            sendMessage("expert");
          }
        });

      function sendMessage(role) {
        console.log("inside send message function", role);
        console.log("userSocket", userSocket);
        console.log("expertSocket", expertSocket);
        const socket = role === "user" ? userSocket : expertSocket;
        const session =
          role === "user" ? currentUserSession : currentExpertSession;
        const input = document.getElementById(`${role}MessageInput`);
        const container = `${role}Messages`;

        console.log("session", session);
        console.log("input", input.value.trim());
        console.log("container", container);

        if (!socket || !session || !input.value.trim()) {
          log(
            `Cannot send message: ${role} socket or session not initialized, or input is empty`,
            "error"
          );
          return;
        }

        const messageData = {
          sessionId: session.sessionId,
          roomId: session.roomId,
          message: input.value.trim(),
          type: "text",
        };

        console.log(messageData);

        socket.emit("send_message", messageData);
        addMessage(
          container,
          {
            senderId: "You",
            message: input.value.trim(),
            timestamp: new Date(),
          },
          "sent"
        );

        input.value = "";
        log(`Message sent: ${messageData.message}`, "info");
      }

      // Session End Functions
      document
        .getElementById("endUserSession")
        .addEventListener("click", () => {
          if (userSocket && currentUserSession) {
            userSocket.emit("end_session", {
              sessionId: currentUserSession.sessionId,
            });
          }
        });

      document
        .getElementById("endExpertSession")
        .addEventListener("click", () => {
          if (expertSocket && currentExpertSession) {
            expertSocket.emit("end_session", {
              sessionId: currentExpertSession.sessionId,
            });
          }
        });

      // Reset Functions
      function resetUserSession() {
        currentUserSession = null;
        document.getElementById("userSessionActions").classList.add("hidden");
        document.getElementById("userChatSection").classList.add("hidden");
        document.getElementById("userCallSection").classList.add("hidden");
        document.getElementById("userMessages").innerHTML = "";
        if (userAgoraClient) {
          userAgoraClient.leave();
          userAgoraClient = null;
        }
      }

      function resetExpertSession() {
        currentExpertSession = null;
        document.getElementById("expertSessionActions").classList.add("hidden");
        document.getElementById("expertChatSection").classList.add("hidden");
        document.getElementById("expertCallSection").classList.add("hidden");
        document.getElementById("expertMessages").innerHTML = "";
        if (expertAgoraClient) {
          expertAgoraClient.leave();
          expertAgoraClient = null;
        }
      }

      // Agora Functions (Basic implementation)
      async function initializeUserAgora() {
        try {
          userAgoraClient = AgoraRTC.createClient({
            mode: "rtc",
            codec: "vp8",
          });

          await userAgoraClient.join(
            currentUserSession.agoraAppId,
            currentUserSession.agoraChannelName,
            currentUserSession.agoraToken,
            null
          );

          log("User joined Agora channel", "success");

          if (currentUserSession.mode === "video") {
            const localVideoTrack = await AgoraRTC.createCameraVideoTrack();
            localVideoTrack.play("userLocalVideo");
            await userAgoraClient.publish([localVideoTrack]);
          }

          if (
            currentUserSession.mode === "call" ||
            currentUserSession.mode === "video"
          ) {
            const localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
            await userAgoraClient.publish([localAudioTrack]);
          }

          userSocket.emit("agora_call_status", {
            sessionId: currentUserSession.sessionId,
            status: "connected",
          });
        } catch (error) {
          log(`Agora initialization error: ${error.message}`, "error");
        }
      }

      async function initializeExpertAgora() {
        try {
          expertAgoraClient = AgoraRTC.createClient({
            mode: "rtc",
            codec: "vp8",
          });

          await expertAgoraClient.join(
            currentExpertSession.agoraAppId,
            currentExpertSession.agoraChannelName,
            currentExpertSession.agoraToken,
            null
          );

          log("Expert joined Agora channel", "success");

          if (currentExpertSession.mode === "video") {
            const localVideoTrack = await AgoraRTC.createCameraVideoTrack();
            localVideoTrack.play("expertLocalVideo");
            await expertAgoraClient.publish([localVideoTrack]);
          }

          if (
            currentExpertSession.mode === "call" ||
            currentExpertSession.mode === "video"
          ) {
            const localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
            await expertAgoraClient.publish([localAudioTrack]);
          }

          expertSocket.emit("agora_call_status", {
            sessionId: currentExpertSession.sessionId,
            status: "connected",
          });
        } catch (error) {
          log(`Agora initialization error: ${error.message}`, "error");
        }
      }

      // Clear logs function
      document.getElementById("clearLogs").addEventListener("click", () => {
        document.getElementById("logs").innerHTML = "";
      });

      // Initialize
      log("Socket Server Test Interface loaded", "success");
    </script>
  </body>
</html>
